{% extends 'base.html' %}
{% load static %}

{% block content %}


    <div class="media mx-5 border-bottom border-secondary">
        <div class="col-auto">
            <img src="{{question.author.avatar.url}}" class="img-fluid rounded" alt="..." >
            <p class="font-weight-bold mt-3 mb-1">
                <div class="text-center" id="rating_{{ question.id }}">{{ question.rating }}</div>
            </p>
            {% if user.is_authenticated %}
                <div class="row mt-3">
                    <div class="likes">
                        <button type="button" name="like_btn" class="mx-2" onclick="like('question', {{ question.id }})" title="Like">
                            {% if like == 1 %}
                                <img id="like_img_{{ question.id }}" src="{% static 'img/like_active.png' %}" width="17px">
                            {% else %}
                                <img id="like_img_{{ question.id }}" src="{% static 'img/like.png' %}" width="17px">
                            {% endif %}
                        </button>

                        <button type="button" name="like_btn" class="" onclick="dislike('question', {{ question.id }})" title="Dislike">
                            {% if like == -1 %}
                                <img id="dislike_img_{{ question.id }}" src="{% static 'img/dislike_active.png' %}" width="17px">
                            {% else %}
                                <img id="dislike_img_{{ question.id }}" src="{% static 'img/dislike.png' %}" width="17px">
                            {% endif %}
                        </button>
                    </div>
                </div>
            {% else %}
                <div class="row mt-3">
                    <div class="likes">
                        <button disabled type="button" name="like_btn" class="mx-2">
                            <img src="{% static 'img/like.png' %}" width="17px">
                        </button>

                        <button disabled type="button" name="like_btn" class="" >
                            <img src="{% static 'img/dislike.png' %}" width="17px">
                        </button>
                    </div>
                </div>
            {% endif %}

        </div>
        <div class="col-auto media-body">
            <div class="text-left">
                <h5 class="mt-0">{{ question.title }}</h5>
                <p class="text-secondary">{{question.author.username}}</p>
                <p class="clip text-break" style=" word-wrap: break-word; height: auto; width: auto; text-overflow: ellipsis;">{{ question.question_text }}</p>
            </div>
            <div class="mb-3">
                Tags:
                <span class="mr-2"></span>
                {% for tag in question.tags.all %}
                    <a href="{% url 'ask_me:tag' tag.tag_name %}" class="badge badge-secondary">{{ tag.tag_name }}</a>
                {% endfor %}
                <p class="text-right text-secondary m-0">{{ question.make_time }}</p>
            </div>
        </div>
    </div>

    <div id="answers" class=" mx-5 border-bottom border-secondary">
        {% if answers %}
            {% for post, like in votes.items %}
                <div class="my-3">
                    {% include 'inc/answer.html' with answer=post like=like question=question %}
                </div>
            {% endfor %}
            {% include 'inc/pagination.html' with page=answers %}
        {% endif %}
    </div>
    {% if user.is_authenticated %}
        <div class="col-8 my-4 mx-auto">
            <form action="" method="post">
                {% csrf_token %}
                <p>{{ form.answer_text }}</p>
                <p><input class="btn btn-secondary" type="submit" value="Answer"></p>
            </form>
        </div>
    {% endif %}

    <script src="{% static '/js/centrifuge.min.js' %}"></script>
    <script type="text/javascript">
        cent = new Centrifuge('ws://127.0.0.1:8001/connection/websocket');
        cent.setToken("{{ token }}");
        cent.subscribe('{{ question.id }}', function (msg) {
            var ms = msg.data;
            //console.log(msg['hello'])
            //alert(ms['hello']);
            $('#answers').prepend('<div class="my-3">' +
                '<div class="mx-5 border border-secondary rounded">\n' +
                '    <div class="row mx-2 my-2">\n' +
                '        <div class="col-auto">\n' +
                '            <img src="'+ ms['avatar'] +'" class="img-fluid rounded" alt="..." >\n' +
                '            <p class="text-center font-weight-bold mt-3 mb-1">\n' +
                '                <div class="text-center" id="rating_'+ ms['id'] +'"> 0 </div>\n' +
                '            </p>\n' +
                    '                <div class="row mt-3">\n'+
                    '                    <div class="likes">\n'+
                    '                        <button type="button" name="like_btn" class="mx-2" onclick="like(\'answer\', '+ ms['id'] +')" title="Like">\n'
                    +
                    '                            <img id="like_img_'+ ms['id'] +'" src="{% static 'img/like.png' %}" width="17px">\n'+
                    '                        </button>\n'+
                    '\n'+
                    '                        <button type="button" name="like_btn" class="" onclick="dislike(\'answer\', '+ ms['id'] +')" title="Dislike">\n'
                    +
                    '                            <img id="dislike_img_'+ ms['id'] +'" src="{% static 'img/dislike.png' %}" width="17px">\n'+
                    '                        </button>\n'+
                    '                    </div>\n'+
                    '                </div>\n'+
                '\n' +
                '        </div>\n' +
                '        <div class="col-auto media-body">\n' +
                '            <div>\n' +
                '                <h6 class="text-dark mt-2">\n' +
                '                    '+ ms['author'] +'\n' +
                '                </h6>\n' +
                '                <p class="text-break">\n' +
                '                    '+ ms['text'] +'\n' +
                '                </p>\n' +
                '            </div>\n' +
                '            <div>\n' +
                '                <p class="text-right text-secondary m-0">'+ ms['time'] +'</p>\n' +
                '            </div>\n' +
                '        </div>\n' +
                '    </div>\n' +
                '</div>' +
                '</div>');
            });
        cent.connect();
    </script>

{% endblock %}

{% block custom_javascript %}
    <script src="{% static 'js/like.js' %}"></script>
{% endblock %}